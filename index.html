<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>C1 English Quiz – Remote (15 min, dynamic)</title>
<style>
  :root{--bg:#0b1220;--card:#121a2b;--text:#e6eef9;--muted:#a9b6cc;--accent:#4cc9f0;--ok:#2bd576;--bad:#ff6b6b;--border:#23304a;--warn:#ffd166}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:900px;margin:32px auto;padding:24px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px}
  h1{font-size:1.6rem;margin:0 0 6px}
  p.lead{color:var(--muted);margin:0 0 8px}
  .meta{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
  .timer{font-weight:800;color:var(--accent);border:1px solid var(--border);padding:6px 10px;border-radius:10px;background:#0a1326}
  .q{padding:16px;border:1px solid var(--border);border-radius:12px;margin:16px 0}
  .options{display:grid;gap:10px}
  .options label{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;cursor:pointer}
  .options input{margin-top:3px}
  .options label:hover{border-color:var(--accent)}
  .correct{border-color:var(--ok)!important;box-shadow:0 0 0 2px color-mix(in oklab,var(--ok) 35%, transparent)}
  .incorrect{border-color:var(--bad)!important;box-shadow:0 0 0 2px color-mix(in oklab,var(--bad) 35%, transparent)}
  .explain{margin-top:6px;color:var(--muted);font-size:0.95rem}
  .controls{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px}
  button{background:var(--accent);color:#001018;border:none;padding:12px 18px;font-weight:700;border-radius:12px;cursor:pointer}
  button.secondary{background:#1f2a44;color:var(--text);border:1px solid var(--border)}
  .results{margin-top:22px;padding:16px;border:1px dashed var(--border);border-radius:12px}
  .tag{display:inline-block;margin-right:8px;padding:2px 8px;border-radius:999px;font-size:0.85rem;border:1px solid var(--border);color:var(--muted)}
  .score-ok{color:var(--ok)} .score-mid{color:var(--warn)} .score-bad{color:var(--bad)}
  .footer{margin-top:24px;color:var(--muted);font-size:0.9rem}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>C1 English Quiz – Grammar, Vocabulary, Syntax & Use of English</h1>
    <p class="lead">Answer all <strong>20 multiple-choice</strong> questions (radio buttons).
    Click <strong>Submit</strong> once to grade everything. A fresh random set of 20 is drawn
    from remote JSON files on every load/reset.</p>
    <div class="meta">
      <div>
        <span class="tag">17–20 = Kudos!</span>
        <span class="tag">15 = Good job!</span>
        <span class="tag">Otherwise = Keep working to achieve your goals.</span>
      </div>
      <div class="timer" id="timer" aria-live="polite" title="Time remaining">15:00</div>
    </div>

    <form id="quiz"></form>

    <div class="controls">
      <button type="button" id="submitBtn">Submit</button>
      <button type="button" class="secondary" id="resetBtn">Reset (new set)</button>
    </div>

    <div id="results" class="results" hidden></div>
    <div class="footer">Hosted on GitHub Pages. Sources: <code>questions/*.json</code>.
    Timer: <strong>15 minutes</strong> with auto-submit. No duplicates in a set; avoids immediate repeats between resets.</div>
  </div>
</div>

<script>
const REMOTE_SOURCES = [
  './questions/reading.json',
  './questions/use_of_english.json',
  './questions/vocabulary.json',
  './questions/grammar.json',
  './questions/syntax.json'
];
const TOTAL_ITEMS_PER_QUIZ = 20;
const DURATION_SECONDS = 15 * 60;
let LAST_SET_KEYS = new Set();
let graded=false,timerId=null,remaining=DURATION_SECONDS;

const form=document.getElementById('quiz');
const submitBtn=document.getElementById('submitBtn');
const resetBtn=document.getElementById('resetBtn');
const results=document.getElementById('results');
const timerEl=document.getElementById('timer');

const rand=n=>Math.floor(Math.random()*n);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=rand(i+1);[a[i],a[j]]=[a[j],a[i]]}return a}
function formatTime(s){const m=Math.floor(s/60).toString().padStart(2,'0');const sc=(s%60).toString().padStart(2,'0');return ${m}:}
function normalize(s){return (s||'').replace(/\s+/g,' ').trim().toLowerCase()}
function keyOf(q){return normalize(q.prompt)+'||'+q.answer+'||'+(q.choices||[]).map(c=>normalize(c)).join('|')}
function assertItem(q){return !!(q&&typeof q.prompt==='string'&&Array.isArray(q.choices)&&q.choices.length===4&&['a','b','c','d'].includes(q.answer))}
async function fetchJSON(u){const r=await fetch(u,{cache:'no-store'});if(!r.ok) throw new Error(u+': '+r.status);return r.json()}
async function loadRemote(){
  const all=[]; const seen=new Set();
  await Promise.allSettled(REMOTE_SOURCES.map(async u=>{
    try{
      const arr = await fetchJSON(u);
      if(Array.isArray(arr)){
        for(const q of arr){
          if(!assertItem(q)) continue;
          const k=keyOf(q);
          if(!seen.has(k)){ seen.add(k); all.push(q); }
        }
      }
    }catch(e){}
  }));
  return all;
}
function buildQuestionHTML(q,i){
  const qn=q;
  let opt='';
  for(let j=0;j<4;j++){
    const v='abcd'[j], id=${qn}_;
    opt += <label for=""><input id="" type="radio" name="" value="">) </label>;
  }
  return <div class="q" data-q="" data-key="" data-answer=""><h3>) </h3><div class="options"></div><div class="explain" hidden>Correct: <strong></strong> – </div></div>;
}
function pickUnique(pool,lastKeys,n){
  const filt = pool.filter(q=>!lastKeys.has(keyOf(q)));
  const src = (filt.length>=n) ? filt : pool.slice();
  const sel=[]; const keys=new Set(); let guard=0;
  while(sel.length<n && guard<8000){
    guard++; const q=src[rand(src.length)]; const k=keyOf(q);
    if(!keys.has(k)){ keys.add(k); sel.push(q); }
  }
  if(sel.length<n){ for(const q of pool){const k=keyOf(q); if(!keys.has(k)){sel.push(q); keys.add(k); if(sel.length===n) break;} } }
  return {sel, keys};
}
function renderSet(questions){ form.innerHTML = questions.map((q,i)=>buildQuestionHTML(q,i)).join(''); }
function startTimer(){
  timerEl.textContent = formatTime(remaining);
  timerId = setInterval(()=>{
    remaining--; timerEl.textContent = formatTime(Math.max(remaining,0));
    if(remaining<=0){ clearInterval(timerId); if(!graded){ grade(true); } }
  },1000);
}
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }
function grade(auto=false){
  graded = true; stopTimer();
  let score=0,unanswered=0;
  form.querySelectorAll('input[type="radio"]').forEach(r=>r.disabled=true);
  submitBtn.disabled = true;

  for(let i=1;i<=TOTAL_ITEMS_PER_QUIZ;i++){
    const qn=q;
    const block = form.querySelector(\.q[data-q="\"]\);
    const correct = block?.dataset.answer;
    const chosen = form.querySelector(\input[name="\"]:checked\);
    block.querySelectorAll('.options label').forEach(l=>l.classList.remove('correct','incorrect'));
    if(!chosen){ unanswered++; }
    else if(chosen.value===correct){ score++; chosen.parentElement.classList.add('correct'); }
    else { chosen.parentElement.classList.add('incorrect'); }
    const ci = form.querySelector(\input[name="\"][value="\"]\);
    if(ci) ci.parentElement.classList.add('correct');
    const ex = block.querySelector('.explain'); if(ex) ex.hidden=false;
  }
  let msg='';
  if(score>=17){ msg = \<strong class="score-ok">Kudos!</strong> You scored \/20.\; }
  else if(score===15){ msg = \<strong class="score-mid">Good job!</strong> You scored \/20.\; }
  else { msg = \<strong class="score-bad">Keep working to achieve your goals.</strong> You scored \/20.\; }
  const note = auto ? ' (Time is up – auto‑graded.)' : '';
  results.innerHTML = \<p>\\</p><p>Answered: \/\</p>\;
  results.hidden = false;
  results.scrollIntoView({behavior:'smooth'});
}
async function initNew(){
  graded=false; results.hidden=true; results.innerHTML=''; submitBtn.disabled=false; remaining=DURATION_SECONDS;
  const bank = await loadRemote();
  if(bank.length < TOTAL_ITEMS_PER_QUIZ){
    form.innerHTML = '<div class="q"><h3>Not enough remote questions found.</h3><p class="explain">Ensure the JSON files exist and follow the expected schema.</p></div>';
    return;
  }
  const {sel, keys} = pickUnique(bank, LAST_SET_KEYS, TOTAL_ITEMS_PER_QUIZ);
  LAST_SET_KEYS = keys;
  renderSet(sel);
  startTimer();
  window.scrollTo({top:0, behavior:'smooth'});
}
submitBtn.addEventListener('click',()=>grade(false));
resetBtn.addEventListener('click',()=>{ stopTimer(); initNew(); });
document.addEventListener('DOMContentLoaded', initNew);
</script>
</body>
</html>
